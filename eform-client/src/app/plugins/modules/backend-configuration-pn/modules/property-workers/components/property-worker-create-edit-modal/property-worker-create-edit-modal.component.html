
<form [formGroup]="form">
  <h3 mat-dialog-title>{{ (edit ? 'Edit employee' : 'New employee') | translate }}</h3>
  <div mat-dialog-content>
    <mat-tab-group
      dynamicHeight="false"
      [formGroup]="form"
    >
      <mat-tab label="{{'General' | translate }}" id="generalTab">
        <br>
        <div class="modal-columns">
          <div class="d-flex flex-column" id="column1">
            <mat-form-field>
              <mat-label>{{ 'First name' | translate }}</mat-label>
              <input
                matInput
                formControlName="userFirstName"
                required
                type="text"
                id="firstName"
                name="userName"
                tabindex="1"
                cdkFocusInitial>
              <mat-error *ngIf="form.get('userFirstName').hasError('required')">
                Required
              </mat-error>
            </mat-form-field>
            <mat-form-field>
              <mat-label>{{ 'e-mail' | translate }}</mat-label>
              <input
                matInput
                formControlName="workerEmail"
                type="email"
                id="workerEmail"
                required
                tabindex="3">
              <button
                *ngIf="shouldShowGenerateEmailButton()"
                matSuffix
                mat-icon-button
                type="button"
                (click)="generateRandomEmail()"
                matTooltip="{{ 'Generate random email' | translate }}"
                id="generateEmailBtn">
                <mat-icon>autorenew</mat-icon>
              </button>
              <mat-error *ngIf="form.get('workerEmail').hasError('invalidEmail')">
                Invalid email address
              </mat-error>
              <mat-error *ngIf="form.get('workerEmail').hasError('required')">
                Required
              </mat-error>
            </mat-form-field>
            <mat-form-field>
              <mat-label>{{ 'Employee no' | translate }}</mat-label>
              <input
                matInput
                formControlName="employeeNo"
                type="text"
                id="employeeNo"
                tabindex="5">
            </mat-form-field>
            <mat-form-field>
              <mat-label>{{ 'Language' | translate }}</mat-label>
              <mtx-select
                tabindex="7"
                id="profileLanguageSelector"
                [bindLabel]="'name'"
                [bindValue]="'languageCode'"
                [clearable]="false"
                formControlName="languageCode"
                [items]="activeLanguages">
                <ng-template ng-label-tmp let-item="item">
                  {{ item.name | translate }}
                </ng-template>
                <ng-template ng-option-tmp let-item="item">
                  {{ item.name | translate }}
                </ng-template>
              </mtx-select>
            </mat-form-field>
          </div>
          <div class="d-flex flex-column" id="column2">
            <mat-form-field>
              <mat-label>{{ 'Last name' | translate }}</mat-label>
              <input
                matInput
                formControlName="userLastName"
                type="text"
                id="lastName"
                required
                tabindex="2">
              <mat-error *ngIf="form.get('userLastName').hasError('required')">
                Required
              </mat-error>
            </mat-form-field>
            <mat-form-field>
              <mat-label>{{ 'Phone' | translate }}</mat-label>
              <input
                matInput
                formControlName="phoneNumber"
                type="tel"
                name="phoneNumber"
                id="phoneNumber"
                tabindex="4">
            </mat-form-field>
            <mat-form-field>
              <mat-label>{{ 'PIN code' | translate }}</mat-label>
              <input
                matInput
                formControlName="pinCode"
                type="text"
                name="pinCode"
                pattern="([0-9]*|\*{4})"
                id="pinCode"
                tabindex="6">
            </mat-form-field>
          </div>
        </div>
        <div class="modal-columns">
          <mat-form-field>
            <mat-label>{{ 'Current tags' | translate }}</mat-label>
            <mtx-select
              tabindex="8"
              class="custom"
              [dropdownPosition]="'bottom'"
              [bindValue]="'id'"
              [bindLabel]="'name'"
              [items]="availableTags"
              id="tagSelector"
              [multiple]="true"
              appendTo="body"
              formControlName="tags">
            </mtx-select>
          </mat-form-field>
        </div>
        <div class="modal-columns">
          <div class="d-flex flex-column" id="column1">
            <mat-slide-toggle
              color="primary"
              class="mb-2"
              id="resignedToggle"
              formControlName="resigned">
              {{ "Resigned" | translate }}
            </mat-slide-toggle>
          </div>
          <div class="d-flex flex-column" id="column2">
            <mat-form-field *ngIf="selectedDeviceUser.resigned">
              <mat-label>{{ 'Resigned at date' | translate }}</mat-label>
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <input
                required
                matInput
                [matDatepicker]="picker"
                formControlName="resignedAtDate"
                (click)="picker.open()"
              >
              <mat-datepicker #picker></mat-datepicker>
              <mat-error class="text-warn" *ngIf="!selectedDeviceUser.resignedAtDate">
                {{ 'Date is required'| translate }}*
              </mat-error>
            </mat-form-field>
          </div>
        </div>
        <br>
        <div class="modal-columns">
          <div class="d-flex flex-column" id="column1">
            <mat-slide-toggle
              *ngIf="authStateService.checkClaim('time_registration_enable')"
              color="primary"
              class="mb-2"
              id="timeRegistrationEnabledToggle"
              formControlName="timeRegistrationEnabled">
              {{ "Timeregistration" | translate }}
            </mat-slide-toggle>
            <br>
            <mat-slide-toggle
              *ngIf="authStateService.checkClaim('time_registration_enable') && selectedDeviceUser.timeRegistrationEnabled"
              color="primary"
              class="mb-2"
              id="enableMobileAccessToggle"
              formControlName="enableMobileAccess">
              {{ "Mobile timeregistration" | translate }}
            </mat-slide-toggle>
            <br>
            <mat-slide-toggle
              *ngIf="authStateService.checkClaim('task_management_enable') && assignments.length > 0"
              color="primary"
              class="mb-2"
              id="taskManagementEnabledToggle"
              formControlName="taskManagementEnabled">
              {{ "Task management" | translate }}
            </mat-slide-toggle>
          </div>
          <div class="d-flex flex-column" id="column2">
            <mat-slide-toggle
              color="primary"
              class="mb-2"
              id="webAccessEnabled"
              formControlName="webAccessEnabled">
              {{ "Backend user" | translate }}
            </mat-slide-toggle>
            <br>
            <mat-slide-toggle
              color="primary"
              class="mb-2"
              id="archiveEnabled"
              formControlName="archiveEnabled">
              {{ "Archive" | translate }}
            </mat-slide-toggle>
          </div>
        </div>
        <br>
      </mat-tab>
      <mat-tab label="{{'Properties' | translate }}" id="propertiesTab">
        <div class="modal-columns">
          <div class="d-flex flex-column" id="column2">
            <br>
            <mtx-grid
              [data]="availableProperties"
              [columns]="tableHeaders"
              [cellTemplate]="{select: selectTpl}"
              [pageOnFront]="false"
              [rowStriped]="true"
              [showPaginator]="false"
              id="pairingModalTableBody"
            >
            </mtx-grid>

            <ng-template #selectTpl let-row let-i="index">
              <div class="column-select">
                <mat-checkbox
                  id="checkboxCreateAssignment{{ i }}"
                  (change)="addToArray($event, getAssignmentByPropertyId(row.id).propertyId)"
                  [checked]="getAssignmentIsCheckedByPropertyId(row.id)"
                  [disabled]="getAssignmentIsLockedByPropertyId(row.id)"
                ></mat-checkbox>
              </div>
            </ng-template>
            <br>
          </div>
        </div>

      </mat-tab>
      <mat-tab
        *ngIf="selectedDeviceUser.timeRegistrationEnabled"
        label="{{'Timeregistration' | translate }}"
        id="timeregistrationTab">
        <br>
        <div class="modal-columns">
          <div class="d-flex flex-column" id="timeRegistrationColumn">
            <h4>{{ 'Working Hours Configuration' | translate }}</h4>
            <p class="text-muted">{{ 'Configure the start time, end time, and break duration for each day of the week. Times are in minutes from midnight (0-1440).' | translate }}</p>
            
            <!-- Monday -->
            <div class="day-row">
              <h5>{{ 'Monday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time" 
                    [value]="minutesToTime(form.get('startMonday')?.value)"
                    (change)="form.patchValue({startMonday: timeToMinutes($any($event.target).value)})"
                    id="startMonday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endMonday')?.value)"
                    (change)="form.patchValue({endMonday: timeToMinutes($any($event.target).value)})"
                    id="endMonday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakMonday" id="breakMonday">
                </mat-form-field>
              </div>
            </div>

            <!-- Tuesday -->
            <div class="day-row">
              <h5>{{ 'Tuesday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('startTuesday')?.value)"
                    (change)="form.patchValue({startTuesday: timeToMinutes($any($event.target).value)})"
                    id="startTuesday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endTuesday')?.value)"
                    (change)="form.patchValue({endTuesday: timeToMinutes($any($event.target).value)})"
                    id="endTuesday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakTuesday" id="breakTuesday">
                </mat-form-field>
              </div>
            </div>

            <!-- Wednesday -->
            <div class="day-row">
              <h5>{{ 'Wednesday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('startWednesday')?.value)"
                    (change)="form.patchValue({startWednesday: timeToMinutes($any($event.target).value)})"
                    id="startWednesday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endWednesday')?.value)"
                    (change)="form.patchValue({endWednesday: timeToMinutes($any($event.target).value)})"
                    id="endWednesday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakWednesday" id="breakWednesday">
                </mat-form-field>
              </div>
            </div>

            <!-- Thursday -->
            <div class="day-row">
              <h5>{{ 'Thursday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('startThursday')?.value)"
                    (change)="form.patchValue({startThursday: timeToMinutes($any($event.target).value)})"
                    id="startThursday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endThursday')?.value)"
                    (change)="form.patchValue({endThursday: timeToMinutes($any($event.target).value)})"
                    id="endThursday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakThursday" id="breakThursday">
                </mat-form-field>
              </div>
            </div>

            <!-- Friday -->
            <div class="day-row">
              <h5>{{ 'Friday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('startFriday')?.value)"
                    (change)="form.patchValue({startFriday: timeToMinutes($any($event.target).value)})"
                    id="startFriday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endFriday')?.value)"
                    (change)="form.patchValue({endFriday: timeToMinutes($any($event.target).value)})"
                    id="endFriday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakFriday" id="breakFriday">
                </mat-form-field>
              </div>
            </div>

            <!-- Saturday -->
            <div class="day-row">
              <h5>{{ 'Saturday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('startSaturday')?.value)"
                    (change)="form.patchValue({startSaturday: timeToMinutes($any($event.target).value)})"
                    id="startSaturday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endSaturday')?.value)"
                    (change)="form.patchValue({endSaturday: timeToMinutes($any($event.target).value)})"
                    id="endSaturday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakSaturday" id="breakSaturday">
                </mat-form-field>
              </div>
            </div>

            <!-- Sunday -->
            <div class="day-row">
              <h5>{{ 'Sunday' | translate }}</h5>
              <div class="time-inputs">
                <mat-form-field>
                  <mat-label>{{ 'Start time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('startSunday')?.value)"
                    (change)="form.patchValue({startSunday: timeToMinutes($any($event.target).value)})"
                    id="startSunday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'End time' | translate }}</mat-label>
                  <input matInput type="time"
                    [value]="minutesToTime(form.get('endSunday')?.value)"
                    (change)="form.patchValue({endSunday: timeToMinutes($any($event.target).value)})"
                    id="endSunday">
                </mat-form-field>
                <mat-form-field>
                  <mat-label>{{ 'Break (minutes)' | translate }}</mat-label>
                  <input matInput type="number" formControlName="breakSunday" id="breakSunday">
                </mat-form-field>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
  <div mat-dialog-actions class="d-flex flex-row justify-content-end">
    <button
      class="btn-cancel"
      id="{{edit ? 'cancelEditBtn' : 'cancelCreateBtn'}}"
      (click)="hide()"
    >
      {{ 'Cancel' | translate }}
    </button>
    <button
      tabindex="9"
      class="btn-primary btn-primary--icon-left"
      (click)="edit ? updateSingle() : createDeviceUser()"
      [disabled]="form.invalid"
      id="{{edit ? 'saveEditBtn' : 'saveCreateBtn'}}"
    >
      <span>{{ (edit ? 'Save' : 'Create') | translate }}</span>
    </button>
  </div>
</form>
